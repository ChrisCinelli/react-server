<!DOCTYPE html>

<html>
<head>
  <title>FramebackController.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ClientController.html">
                  ClientController.js
                </a>
              
                
                <a class="source" href="ClientRequest.html">
                  ClientRequest.js
                </a>
              
                
                <a class="source" href="ExpressServerRequest.html">
                  ExpressServerRequest.js
                </a>
              
                
                <a class="source" href="FramebackController.html">
                  FramebackController.js
                </a>
              
                
                <a class="source" href="ReactServerAgent.html">
                  ReactServerAgent.js
                </a>
              
                
                <a class="source" href="client.html">
                  client.js
                </a>
              
                
                <a class="source" href="common.html">
                  common.js
                </a>
              
                
                <a class="source" href="config.html">
                  config.js
                </a>
              
                
                <a class="source" href="constants.html">
                  constants.js
                </a>
              
                
                <a class="source" href="logging.html">
                  logging.js
                </a>
              
                
                <a class="source" href="renderMiddleware.html">
                  renderMiddleware.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>FramebackController.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*

This module supports "frameback" functionality.

This is useful when there's a master/detail set of pages, and displaying the
master page is expensive.

For example, a Web based email client might have an URL like "/inbox" that
shows a list of emails, and URLs like "/email/1", "/email/2", etc., to show
the contents of a particular email.

Imagine a user is viewing "/inbox", and clicks through to "/email/32", and
then clicks the back button.  The browser will re-request "/inbox" (assuming
it's not cacheable, etc.)  If displaying "/inbox" is slow, the user will be
forced to wait.

One solution to this is to open details pages such as "/email/32" in a new tab
or window.  The back button no longer works, but the window showing "/inbox"
is still there showing the correct content!

This module offers an alternate way to speed up the back button.  Instead of
opening the details view in the same window (replacing the master view), or
opening in a new window, this library opens the details view in an iframe, and
hides the master view.  It uses HTML5 techniques to change the browser URL
without forcing a page reload.  When the user presses the back button, the
details view is hidden and the master view is displayed- instant back button!

In browsers that don't support HTML5 style history manipulation, the
experience is similar, but the back button isn't speeded up.  No iframe is
used and the library gets out of the way.  You can choose to either open in a
new tab or the same tab (by setting the 'target' attribute of anchors.)

You can use this functionality by simply adding a `frameback={true}` attribute
to your `&lt;Link&gt;` element.

The details page linked to need not itself be a react-server page.  If it _is_ a
react-server page it will have its client-navigation disabled.  Any navigation away
from the details page will result in a full navigation of the outer window
away from the master.  Thus only the master=&gt;details=&gt;back navigation is
speeded up.

*/</span>

<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;

<span class="hljs-keyword">var</span> Q      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>)
,   logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./logging'</span>).getLogger(__LOGGER__)
,   RLS    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/RequestLocalStorage'</span>).getNamespace()

<span class="hljs-keyword">var</span> ClientRequest = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ClientRequest'</span>);
<span class="hljs-keyword">var</span> History = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./components/History'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is an attribute that’s added to the main content div that contains all
react-server elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> {PAGE_CONTENT_NODE_ID} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./constants'</span>);

<span class="hljs-keyword">var</span> _ = {
	assign: <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/assign'</span>),
	forEach: <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/forEach'</span>),
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Cover the whole viewport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> FRAME_STYLE = {
	<span class="hljs-string">'border'</span>   : <span class="hljs-string">'0px'</span>,
	<span class="hljs-string">'position'</span> : <span class="hljs-string">'absolute'</span>,
	<span class="hljs-string">'top'</span>      : <span class="hljs-string">'0px'</span>,
	<span class="hljs-string">'left'</span>     : <span class="hljs-string">'0px'</span>,
	<span class="hljs-string">'width'</span>    : <span class="hljs-string">'100%'</span>,
	<span class="hljs-string">'height'</span>   : <span class="hljs-string">'100%'</span>,
	<span class="hljs-string">'display'</span>  : <span class="hljs-string">'block'</span>,
	<span class="hljs-string">'zIndex'</span>   : <span class="hljs-string">'10'</span>,
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FramebackController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>This is only works from the outer frame.
It’s deprecated.  Access via the RequestContext.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">static</span> getCurrent() {
		<span class="hljs-keyword">return</span> RLS().instance;
	}

	<span class="hljs-keyword">constructor</span>() {
		<span class="hljs-keyword">super</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We’ll set this when we’re showing the details page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.active = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>When we navigate back from a details page we’ll restore the
outer page’s title to that of the master page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.masterTitle = <span class="hljs-built_in">document</span>.title;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Stash ourselves in request local storage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		RLS().instance = <span class="hljs-keyword">this</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Are we currently showing a details page in an iframe?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	isActive(){
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.active;
	}

	navigate(request){
		<span class="hljs-keyword">const</span> url = request.getUrl();

		logger.debug(<span class="hljs-string">`Navigating to <span class="hljs-subst">${url}</span>`</span>);

		<span class="hljs-keyword">this</span>.loadTimer = logger.timer(<span class="hljs-string">'loadTime'</span>);

		<span class="hljs-keyword">this</span>.active = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>update master title in case the title has changed since initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.masterTitle = <span class="hljs-built_in">document</span>.title;

		<span class="hljs-keyword">this</span>.hideMaster();

		<span class="hljs-keyword">if</span> (url !== <span class="hljs-keyword">this</span>.url){

			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.frame &amp;&amp; request.getReuseFrame()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If we have a frame and the request permits
us to reuse it by performing a client
transition we’ll do that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">this</span>.navigateFrame(request);

			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Otherwise we, unfortunately, can’t just
point an existing frame at a new page since
that would be a navigation.  So, we’ll
destroy it and create a fresh replacement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.frame){
					<span class="hljs-keyword">this</span>.destroyFrame();
				}

				<span class="hljs-keyword">this</span>.createFrame(url);
			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>One way or another we’ve got a frame pointed at this URL now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.url = url;

		<span class="hljs-keyword">this</span>.showFrame();</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Should we wait for the details page to load?
I don’t think so.  We want the back button to be snappy.
If the user clicks back before the page finishes loading
we’ll just abandon the frame.  If that causes some issue
then we’ll have to return a promise attached to a deferred
that gets resolved in <code>_handleFrameLoad()</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> Q();
	}

	willHandle(request, type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If we’re not in a frame, then we’ve got nothing to do.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.__reactServerIsFrame) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>If this is the initial page load request then the navigator
should handle it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!type || type === History.events.PAGELOAD) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If the request is coming from the outer frame’s frameback
controller, then the navigator should handle it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (request.getOpts()._fromOuterFrame) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Otherwise this is a client transition request from within
our frame, and we need to pass it through the outer frame’s
navigator to get the history navigation stack taken care
of.</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Can’t reuse the frame if our request is for frameback
without frame reuse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">const</span> reuseFrame = request.getReuseFrame() || !request.getFrameback();

		request = <span class="hljs-keyword">new</span> ClientRequest(
			request.getUrl(),
			_.assign({}, request.getOpts(), {
				frameback: <span class="hljs-literal">false</span>, <span class="hljs-comment">// Navigation is _for_ frame.</span>
				reuseFrame,
			})
		);
		<span class="hljs-built_in">window</span>.parent.__reactServerClientController.context
			.navigate(request, type);

		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	}

	navigateBack(){
		logger.debug(<span class="hljs-string">`Navigating back`</span>);
		<span class="hljs-keyword">this</span>.hideFrame();
		<span class="hljs-keyword">this</span>.showMaster();
		<span class="hljs-keyword">this</span>.active = <span class="hljs-literal">false</span>;
	}

	hideMaster(){
		contentDiv().style.display = <span class="hljs-string">'none'</span>;
	}

	showMaster(){
		contentDiv().style.display = <span class="hljs-string">'block'</span>;
		<span class="hljs-built_in">document</span>.title = <span class="hljs-keyword">this</span>.masterTitle;
		<span class="hljs-built_in">document</span>.activeElement.blur();
		<span class="hljs-built_in">window</span>.focus();
	}

	navigateFrame(request){</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>This is a request that we’re going to send to the navigator
<em>in our frame</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">const</span> frameRequest = <span class="hljs-keyword">new</span> ClientRequest(
			request.getUrl(),
			_.assign({}, request.getOpts(), {
				frameback       : <span class="hljs-literal">false</span>, <span class="hljs-comment">// No frameback within frame.</span>
				_fromOuterFrame : <span class="hljs-literal">true</span>,  <span class="hljs-comment">// Actually navigate in frame.</span>
			})
		)

		<span class="hljs-keyword">this</span>.frame.contentWindow
			.__reactServerClientController
			.context
			.navigate(frameRequest,</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The frame isn’t actually managing the
history navigation stack.  We just tell it
that it’s always navigating forward
regardless of what sort of navigation
<em>we’re</em> performing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				History.events.PUSHSTATE
			);
	}

	createFrame(url){

		<span class="hljs-keyword">const</span> frame = <span class="hljs-keyword">this</span>.frame = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"iframe"</span>);

		frame.src = absoluteUrl(url);

		_.forEach(FRAME_STYLE, (v, k) =&gt; {frame.style[k] = v});

		frame.addEventListener(<span class="hljs-string">'load'</span>, () =&gt; <span class="hljs-keyword">this</span>._handleFrameLoad(frame));

		<span class="hljs-built_in">document</span>.body.appendChild(frame);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Set this right away once we have a content window
(available as soon as we’ve appended to the DOM).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		frame.contentWindow.__reactServerIsFrame = <span class="hljs-literal">true</span>;
	}


	showFrame(){
		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'showFrame'</span>);
		<span class="hljs-keyword">this</span>.frame.style.display = <span class="hljs-string">'block'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>We want to put the focus on our child frame
Note that this will fire too soon when we’re creating our
child frame for the first time but will cover the case
where we’re navigating back to a child frame that’s already
been created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.frame.contentWindow.focus();
		<span class="hljs-keyword">this</span>.setTitleFromFrame();
	}

	setTitleFromFrame(){
		<span class="hljs-keyword">var</span> doc = <span class="hljs-keyword">this</span>.frame.contentDocument;
		<span class="hljs-keyword">if</span> (doc.title &amp;&amp; <span class="hljs-keyword">this</span>.active){
			<span class="hljs-built_in">document</span>.title = doc.title;
		}
	}

	hideFrame(){
		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'hideFrame'</span>);
		<span class="hljs-keyword">this</span>.frame.style.display = <span class="hljs-string">'none'</span>;
	}

	destroyFrame(){
		<span class="hljs-built_in">document</span>.body.removeChild(<span class="hljs-keyword">this</span>.frame);
		<span class="hljs-keyword">this</span>.frame = <span class="hljs-literal">null</span>;
	}

	_handleFrameLoad(frame){</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Just in case the user navigated back and to a different
frame while we were waiting for the first frame to load.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (frame !== <span class="hljs-keyword">this</span>.frame) <span class="hljs-keyword">return</span>;

		<span class="hljs-keyword">const</span> clientController = frame.contentWindow.__reactServerClientController;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If the frame has a client controller we’ll listen to when
<em>it</em> tells us it’s done loading.</p>
<p>It may have finished <em>before</em> we get here, so we’ll also check
whether it has already set its <code>_previouslyRendered</code> flag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (clientController &amp;&amp; !clientController.__parentIsListening &amp;&amp; !clientController._previouslyRendered) {
			clientController.__parentIsListening = <span class="hljs-literal">true</span>;
			clientController.context.onLoadComplete(<span class="hljs-keyword">this</span>._handleFrameLoad.bind(<span class="hljs-keyword">this</span>, frame));
			<span class="hljs-keyword">return</span>;
		}

		[].slice.call(frame.contentDocument.body.querySelectorAll(<span class="hljs-string">'a'</span>)).forEach(link =&gt; {
			<span class="hljs-keyword">if</span> (!link.target) link.target = <span class="hljs-string">'_top'</span>;
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>We’ve got it now, so let’s set it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.setTitleFromFrame();</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>When a frame is created for the first time, we need to wait
for it to load before giving it focus</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.frame.contentWindow.focus();

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loadTimer) {

			<span class="hljs-keyword">this</span>.loadTimer.stop();
			<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.loadTimer;

			logger.debug(<span class="hljs-string">"Frame loaded"</span>);
		} <span class="hljs-keyword">else</span> {
			logger.debug(<span class="hljs-string">"Frame navigated"</span>);
		}

	}
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">contentDiv</span>(<span class="hljs-params"></span>)</span>{
	<span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.body.querySelector(<span class="hljs-string">`div[<span class="hljs-subst">${PAGE_CONTENT_NODE_ID}</span>]`</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">absoluteUrl</span>(<span class="hljs-params">url</span>)</span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === url.indexOf(<span class="hljs-string">'/'</span>)) {
		url = <span class="hljs-built_in">window</span>.location.protocol + <span class="hljs-string">'//'</span> + <span class="hljs-built_in">window</span>.location.host + url;
	}
	<span class="hljs-keyword">return</span> url;
}

<span class="hljs-built_in">module</span>.exports = FramebackController;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
